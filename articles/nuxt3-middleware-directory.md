---
title: "[å’Œè¨³] Nuxt3 å…¬å¼ã‚µã‚¤ãƒˆ~Middleware Directory"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [nuxtjs,nuxt3]
published: true
---
# ã“ã®è¨˜äº‹ã«ã¤ã„ã¦
ã“ã®è¨˜äº‹ã¯[Nuxt3 å…¬å¼ã‚µã‚¤ãƒˆ Middleware Directory](https://nuxt.com/docs/guide/directory-structure/middleware) ã‚’å’Œè¨³ã—ãŸã‚‚ã®ã«ãªã‚Šã¾ã™ï¼ˆæ—¥æœ¬èªãŒä¸è‡ªç„¶ã«ãªã£ã¦ã—ã¾ã£ã¦ã„ã‚‹ç®‡æ‰€ãŒã‚ã‚‹ã®ã¯ã”ã‚ã‚“ãªã•ã„ï¼‰ã€‚
https://nuxt.com/docs/guide/directory-structure/middleware

# Middleware Directory
Nuxt ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã§ä½¿ãˆã‚‹ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ãª**ãƒ«ãƒ¼ãƒˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢**ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’æä¾›ã—ã€ã“ã‚Œã¯ç‰¹å®šã®ãƒ«ãƒ¼ãƒˆã«ãƒŠãƒ“ã‚²ãƒ¼ãƒˆã™ã‚‹å‰ã«å®Ÿè¡Œã—ãŸã„ã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã™ã‚‹ã®ã«ç†æƒ³çš„ã§ã™ã€‚

ãƒ«ãƒ¼ãƒˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯ Nuxt ã‚¢ãƒ—ãƒªã® Vue ã®éƒ¨åˆ†ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚åå‰ã¯ä¼¼ã¦ã„ã¾ã™ãŒã€ã‚¢ãƒ—ãƒªã® Nitro ã‚µãƒ¼ãƒãƒ¼éƒ¨åˆ†ã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚µãƒ¼ãƒãƒ¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¨ã¯å…¨ãç•°ãªã‚Šã¾ã™ã€‚

ãƒ«ãƒ¼ãƒˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã«ã¯3ç¨®é¡ã‚ã‚Šã¾ã™ã€‚
1. åŒ¿åï¼ˆã¾ãŸã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ï¼‰ã®ãƒ«ãƒ¼ãƒˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã€ä½¿ç”¨ã™ã‚‹ãƒšãƒ¼ã‚¸å†…ã§ç›´æ¥å®šç¾©ã•ã‚Œã‚‹ã‚‚ã®ã€‚
2. åå‰ä»˜ããƒ«ãƒ¼ãƒˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã€`middleware/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç½®ã‹ã‚Œã€ãƒšãƒ¼ã‚¸ã§ä½¿ã†æ™‚ã«éåŒæœŸã‚¤ãƒ³ãƒãƒ¼ãƒˆã§è‡ªå‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã‚‹ã‚‚ã®ï¼ˆæ³¨æ„ï¼šãƒ«ãƒ¼ãƒˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®åå‰ã¯ã‚±ãƒãƒ–ã‚±ãƒ¼ã‚¹ã«æ­£è¦åŒ–ã•ã‚Œã‚‹ã®ã§ã€`someMiddleware` ã¯ `some-middleware` ã«ãªã‚Šã¾ã™ï¼‰ã€‚
3. ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ«ãƒ¼ãƒˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã€`middleware/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç½®ã‹ã‚Œï¼ˆã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¯ `.global` ï¼‰ã€ãƒ«ãƒ¼ãƒˆãŒå¤‰æ›´ã•ã‚Œã‚‹ãŸã³ã«è‡ªå‹•çš„ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚‚ã®ã€‚

æœ€åˆã®2ç¨®é¡ã®ãƒ«ãƒ¼ãƒˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯ `definePageMeta` ã§å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## Format
ãƒ«ãƒ¼ãƒˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯ç¾åœ¨ã®ãƒ«ãƒ¼ãƒˆã¨æ¬¡ã®ãƒ«ãƒ¼ãƒˆã‚’å¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚‹ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ãƒ¼ãƒ‰ã§ã™ã€‚

```ts
export default defineNuxtRouteMiddleware((to,from) => {
  if(to.params.id === '1') {
    return abortNavigation()
  }
  return navigationTo('/')
})
```

Nuxt ã¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‹ã‚‰ç›´æ¥è¿”ã™ã“ã¨ãŒã§ãã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«åˆ©ç”¨å¯èƒ½ãªãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’2ã¤æä¾›ã—ã¾ã™ã€‚
1. ```ts
   navigateTo(to: RouteLocateRow | undefined | null, options?: {replace: boolean, redirectCode: number, external: boolean})
   ```
   ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚„ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ä¸­ã§ä¸ãˆã‚‰ã‚ŒãŸãƒ«ãƒ¼ãƒˆã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚ãƒšãƒ¼ã‚¸é·ç§»ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ç›´æ¥å‘¼ã³å‡ºã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
2. ```ts
   abortNavigation(err?: string | Error)
   ```
   ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¸­æ­¢ã—ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

vue-router ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ã‚‹ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰ã¨ã¯ç•°ãªã‚Šã€`next()` ã®ç¬¬3å¼•æ•°ã¯æ¸¡ã•ã‚Œãšã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚„ãƒ«ãƒ¼ãƒˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‹ã‚‰å€¤ã‚’è¿”ã™ã“ã¨ã§å‡¦ç†ã•ã‚Œã¾ã™ã€‚è¿”ã‚Šå€¤ã®å€™è£œã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
- ä½•ã‚‚è¿”ã•ãªã„ - ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¦¨ã’ãšã€æ¬¡ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢é–¢æ•°ãŒã‚ã‚Œã°ãã‚Œã«ç§»è¡Œã™ã‚‹ã‹ã€ãƒ«ãƒ¼ãƒˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Œäº†ã•ã›ã¾ã™ã€‚
- `return navigateTo('/')` ã¾ãŸã¯ `return navigateTo({path: '/'})` - ä¸ãˆã‚‰ã‚ŒãŸãƒ‘ã‚¹ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãŒã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§è¡Œã‚ã‚ŒãŸå ´åˆã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ `302` Found ã«è¨­å®šã—ã¾ã™ã€‚
- `return navigateTo('/', {redirectCode: 301})` - ä¸ãˆã‚‰ã‚ŒãŸãƒ‘ã‚¹ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãŒã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§è¡Œã‚ã‚ŒãŸå ´åˆã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ `301` Moved Permanently ã«è¨­å®šã—ã¾ã™ã€‚
- `return abortNavigation()` - ç¾åœ¨ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã™ã€‚
- `return abortNavigation(error)` - ç¾åœ¨ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¨ãƒ©ãƒ¼ã§æ‹’å¦ã—ã¾ã™ã€‚


`navigateTo()` ã®è©³ç´°ã¯ä¸‹è¨˜ãƒšãƒ¼ã‚¸ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
https://nuxt.com/docs/api/utils/navigate-to
`abortNavigation()` ã®è©³ç´°ã¯ä¸‹è¨˜ãƒšãƒ¼ã‚¸ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
https://nuxt.com/docs/api/utils/abort-navigation

:::message
ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã®å®Ÿè¡Œã‚„ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®åœæ­¢ã«ã¯ä¸Šè¨˜ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚vue-router ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ä»–ã®æˆ»ã‚Šå€¤ã§ã‚‚å‹•ä½œã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ãŒã€å°†æ¥çš„ã«ç ´å£Šçš„ãªå¤‰æ›´ãŒã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
:::

## When Middleware Runs
ã‚µã‚¤ãƒˆãŒã‚µãƒ¼ãƒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¾ãŸã¯ç”Ÿæˆã•ã‚Œã‚‹å ´åˆã€åˆæœŸãƒšãƒ¼ã‚¸ç”¨ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯ãƒšãƒ¼ã‚¸ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§å†åº¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã‚’å¿…è¦ã¨ã™ã‚‹å ´åˆã€ä¾‹ãˆã°ç”Ÿæˆã•ã‚ŒãŸã‚µã‚¤ãƒˆã§ç©æ¥µçš„ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãŸã‚Šã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å€¤ã‚’èª­ã¿è¾¼ã‚“ã ã‚Šã™ã‚‹æ™‚ã«å¿…è¦ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã‹ã‚‰ã§ã™ã€‚

ã—ã‹ã—ã€ã“ã®å‹•ä½œã‚’é¿ã‘ãŸã„å ´åˆã¯ã€ãã†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
export default defineNuxtRouteMiddleware(to => {
  // ã‚µãƒ¼ãƒãƒ¼ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ã‚¹ã‚­ãƒƒãƒ—
  if (process.server) return
  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’å®Œå…¨ã«ã‚¹ã‚­ãƒƒãƒ—
  if (process.client) return
  // ã¾ãŸã¯ã€æœ€åˆã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ­ãƒ¼ãƒ‰æ™‚ã®ã¿ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ã‚¹ã‚­ãƒƒãƒ—
  const nuxtApp = useNuxtApp()
  if (process.client && nuxtApp.isHydrating && nuxtApp.payload.serverRendered) return
```

## Adding Middleware Dynamically
ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å†…ãªã©ã‹ã‚‰ `addRouteMiddleware()` ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã‚°ãƒ­ãƒ¼ãƒãƒ«ã¾ãŸã¯åå‰ä»˜ããƒ«ãƒ¼ãƒˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’æ‰‹å‹•ã§è¿½åŠ ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

```ts
export default defineNuxtPlugin(() => {
  addRouteMiddleware('global-test', () => {
    console.log('this global middleware was added in a plugin and will be run on every route change')
  }, { global: true })
  addRouteMiddleware('named-test', () => {
    console.log('this named middleware was added in a plugin and would override any existing middleware of the same name')
  })
})
```

## Example: A Named Route Middleware
```
middleware/
â”” auth.ts
```
ãƒšãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«å†…ã§ã€ã“ã®ãƒ«ãƒ¼ãƒˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’å‚ç…§ã§ãã¾ã™ã€‚
```Vue
<script setup>
definePageMeta({
  middleware: ["auth"]
  // ã¾ãŸã¯ middleware: 'auth' ã¨æŒ‡å®š
})
</script>
```
ã“ã†ã™ã‚‹ã“ã¨ã§ã€ãã®ãƒšãƒ¼ã‚¸ã¸ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Œäº†ã™ã‚‹å‰ã«ã€`auth` ãƒ«ãƒ¼ãƒˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ä¸‹è¨˜ãƒšãƒ¼ã‚¸ã§å®Ÿéš›ã®ä¾‹ã‚’è¦‹ãŸã‚Šç·¨é›†ã—ãŸã‚Šã§ãã¾ã™ã€‚
https://nuxt.com/docs/examples/routing/middleware